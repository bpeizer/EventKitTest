node {
  def root = pwd()
  def nodejs = tool 'NodeJS_6'
  //def PCF_SPACE = 'pz-int pz-stage pz-test'
  
  stage('Clean') {
    deleteDir()
  }

  stage('Setup') {
    git([
      url: "https://github.com/bpeizer/EventkitTest",
      poll: true,
      branch: "master"
    ])
  }
    stage ('Docker Selenium Container') {
        sh '''
            # docker run -d -p 4444:4444 -p 5900:5900 -v /dev/shm:/dev/shm selenium/standalone-chrome-debug:3.11.0-antimony
            # docker run -d -p 4445:4445 -p 5901:5901 -v /dev/shm:/dev/shm selenium/standalone-firefox-debug:3.11.0-antimony
        '''
    }
  stage('Test') {
    withCredentials([file(credentialsId: 'eventkit_postman_environment', variable: 'POSTMAN_FILE')]) {
      withEnv(["PATH+=${root}/node_modules/newman/bin:${nodejs}/bin", "HOME=${root}"]){ 
      withEnv(["DISPLAY=:0"]){
           sh "npm install -g newman"
           sh '''           
            echo PATH=$PATH
            echo HOME=$HOME
            sh EventKit.sh
            '''
 
               }  
              }
         }
  }
         
 stage ('Cleanup') {
    deleteDir()
  }
}
