node {
  def root = pwd()
  def nodejs = tool 'NodeJS_6'
  //def PCF_SPACE = 'pz-int pz-stage pz-test'
  
  stage('Clean') {
    deleteDir()
  }

  stage('Setup') {
    git([
      url: "https://github.com/bpeizer/EventkitTest",
      poll: true,
      branch: "master"
    ])
  }
    stage ('Install Browser') {
        sh '''
            # Install Chromium.
            # sudo apt-get -y install chromium-browser

            # Install GeckoDriver.
            # wget -N https://github.com/mozilla/geckodriver/releases/download/v0.19.1/geckodriver-v0.19.1-linux64.tar.gz -P Selenium
            # tar -xzf Selenium/geckodriver-v0.19.1-linux64.tar.gz -C Selenium
            # rm Selenium/geckodriver-v0.19.1-linux64.tar.gz

            # Install ChromeDriver.
            wget -N http://chromedriver.storage.googleapis.com/2.35/chromedriver_linux64.zip -P Selenium
            unzip -o Selenium/chromedriver_linux64.zip -d Selenium
            rm Selenium/chromedriver_linux64.zip
        '''
    }
  stage('Test') {
    withCredentials([file(credentialsId: 'eventkit_postman_environment', variable: 'POSTMAN_FILE')]) {
    withCredentials([usernamePassword(credentialsId: 'eventkit_geoxis', usernameVariable: 'GEOAXIS_USERNAME', passwordVariable: 'GEOAXIS_PASSWORD')]) {
    withCredentials([usernamePassword(credentialsId: 'eventkit_saucelabs', usernameVariable: 'SAUCE_USERNAME', passwordVariable: 'SAUCE_ACCESS_KEY')]) {
      withEnv(["PATH+=${root}/node_modules/newman/bin:${nodejs}/bin", "HOME=${root}"]){ 
      withEnv(["DISPLAY=:0"]){
           sh "npm install -g newman"
           sh "java -jar selenium-server-standalone.jar&"
           sh '''           
            echo PATH=$PATH
            echo HOME=$HOME
            sh EventKit.sh
            '''
 
               }  
              }
            }   
           }
         }
  }
         
 stage ('Cleanup') {
    deleteDir()
  }
}
